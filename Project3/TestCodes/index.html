<!DOCTYPE html>
<meta charset="utf-8">
<title>D3.js US Map with Zoom to State and Click on County</title>
<style>
    .background {
        fill: none;
        pointer-events: all;
    }

    #states {
        fill: #aaa;
    }

    #states {
        display: none;
    }

    #state-borders {
        fill: none;
        stroke: #fff;
        stroke-width: 1.5px;
        stroke-linejoin: round;
        stroke-linecap: round;
        pointer-events: none;
    }

    .county-boundary {
        fill: #aaa;
        stroke: #fff;
        stroke-width: .5px;
    }

    /*.county-boundary:hover,*/
    .state:hover {
        fill: #DCCE70;
    }

    div.tooltip {
        position: absolute;
        text-align: left;
        padding: 5px;
        font: 12px sans-serif;
        color: white;
        background: black;
        border: 1px;
        border-radius: 4px;
        pointer-events: none;
    }

</style>
<body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script src="http://d3js.org/d3.geo.tile.v0.min.js"></script>
<script>


    var test;

    var width = 960,
            height = 500,
            centered;

    var projection = d3.geo.albersUsa()
            .scale(1070)
            .translate([width / 2, height / 2]);

    var path = d3.geo.path()
            .projection(projection);

    var svg = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height);

    svg.append("rect")
            .attr("class", "background")
            .attr("width", width)
            .attr("height", height)
            .on("click", clicked);

    var g = svg.append("g");

    var div = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

    dataAll = {};

    d3.csv("Data/county2012.csv", function(error, data) {
        if (error) throw error;
        data.forEach(function(d){
            if(dataAll[d.FIPS]==undefined)
                dataAll[d.FIPS] = [];
            dataAll[d.FIPS] = { "name": d.County,
                                "state": d.State,
                                "fips": d.FIPS,
                                "state_fips" : d.State_FIPS,
                                "dvote" : d.Dvote,
                                "dpercent" : +d.Dpercent,
                                "rvote" : d.Rvote,
                                "rpercent" : +d.Rpercent,
                                "ovote" : d.Ovote,
                                "opercent" : +d.Opercent,
                                "winner" : d.Winner,
                                "party" : d.Party,
                                "difference" : +d.Difference,
                                "total" : d.Total };
        });
    });

    stateCodes = {};

    d3.csv("Data/state-data.csv", function(error, data) {
        if (error) throw error;
        data.forEach(function(d){
            if(stateCodes[d.ID]==undefined)
                stateCodes[d.ID] = [];
            stateCodes[d.ID] = { "id": d.ID,
                                "code": d.Code,
                                "name": d.Name };
        });
    });


    d3.json("Data/us.json", function (error, us) {

        test = us;

        g.append("g")
                .attr("id", "counties")
                .selectAll("path")
                .data(topojson.feature(us, us.objects.counties).features)
                .enter().append("path")
                .attr("d", path)
                .attr("class", "county-boundary")
                .style("fill", function(d,i){
                    try{

                        var ex = d.id;
                        if(dataAll[ex].party === "Republican") {
                            return "red";
                        }
                        else
                            return "blue";

                    }catch (error)
                    {
                        return;
                    }

                })
                .on("mouseover", function(d) {

                    dataAll[d.id].name = dataAll[d.id].name.split("").join("").replace(" County","");
                        div.transition()
                            .duration(200)
                            .style("opacity", 1);
                        div.html("<span><u><b>" + dataAll[d.id].name + " County</b></u> (" + dataAll[d.id].winner + " +" + dataAll[d.id].difference + "%)<br>" +
                            "Democrat: " + dataAll[d.id].dpercent + "%<br>" +
                            "Republican: " + dataAll[d.id].rpercent + "%<br><br>" +
                            "Democrat Votes: " + dataAll[d.id].dvote + "<br>" +
                            "Republican Votes: " + dataAll[d.id].rvote + "<br>" + "</span>")
                            .style("left", (d3.event.pageX + 28) + "px")
                            .style("top", (d3.event.pageY - 28) + "px");
                })
                .on("mouseout", function(d) {
                    div.transition()
                            .style("opacity", 0);
                })
                .on("click", countyclicked);

        g.append("g")
                .attr("id", "states")
                .selectAll("path")
                .data(topojson.feature(us, us.objects.states).features)
                .enter().append("path")
                .attr("d", path)
                .attr("class", "state")
                .on("mouseover", function(d) {

                    div.transition()
                        .duration(200)
                        .style("opacity", .9);
                    div.html(stateCodes[d.id].name)
                        .style("left", (d3.event.pageX) + "px")
                        .style("top", (d3.event.pageY - 28) + "px");
                })
                .on("mouseout", function(d) {
                    div.transition()
                        .style("opacity", 0);
                })
                .on("click", clicked);


        g.append("path")
                .datum(topojson.mesh(us, us.objects.states, function (a, b) {
                    return a !== b;
                }))
                .attr("id", "state-borders")
                .attr("d", path);

    });

//    g.selectAll("path")
//        .style("fill", function(d1) {
//            if (d.id==d1.id) {
//                if(dataAll[d.id].rpercent > dataAll[d.id].dpercent)
//                    return "red";
//                else
//                    return "blue";
//            }
//        })


    function clicked(d) {
        var x, y, k;

        if (d && centered !== d) {
            var centroid = path.centroid(d);
            x = centroid[0];
            y = centroid[1];
            k = 4;
            centered = d;
        } else {
            x = width / 2;
            y = height / 2;
            k = 1;
            centered = null;
        }

        g.selectAll("path")
                .classed("active", centered && function (d) {
                            return d === centered;
                        });

        g.transition()
                .duration(750)
                .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
                .style("stroke-width", 1.5 / k + "px");
    }

    function countyclicked(d) {

        alert(d.id);
    }

</script>
</body>


